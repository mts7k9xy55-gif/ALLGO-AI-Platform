<script>
    const API = "https://wandering-dream-51c5allgoai-api.rgvr8syq2x.workers.dev";
    
    let spec = {
      purpose:"",
      target_users:"",
      features:[],
      ui_style:"",
      constraints:[],
      decided:false
    };
    
    const chat = document.getElementById("chat");
    
    function addMsg(text, cls){
      const d=document.createElement("div");
      d.className="msg "+cls;
      d.textContent=text;
      chat.appendChild(d);
      chat.scrollTop=chat.scrollHeight;
    }
    
    async function aiRespond(userText){
      const res = await fetch(API + "/llm", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ spec, message:userText })
      });
      return await res.json();
    }
    
    async function send(){
      const t = document.getElementById("text");
      const text = t.value.trim();
      if(!text) return;
      t.value="";
    
      addMsg(text,"user");
    
      const res = await aiRespond(text);
    
      addMsg(res.reply,"ai");
    
      spec = res.spec;   // ← 状態更新
    
      // 生成段階に到達したらボタン表示
      if(spec.decided){
        const btn=document.createElement("button");
        btn.textContent="アプリを生成する";
        btn.onclick=()=>location.href="earth.html";
        chat.appendChild(btn);
      }
    }
    
    // 初回メッセージ
    addMsg("どんなアプリを作りたい？","ai");
    </script>
    